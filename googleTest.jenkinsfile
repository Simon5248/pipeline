pipeline {
    agent any
    
    environment {
        // è¨­å®šä½ çš„ Maven è·¯å¾‘
        MAVEN_HOME = 'D:\\maven\\apache-maven-3.8.6'
        PATH = "${MAVEN_HOME}\\bin;${env.PATH}"
        MAVEN_OPTS = '-Xmx1024m'
    }
    
    stages {
        stage('æº–å‚™ç’°å¢ƒ') {
            steps {
                echo 'é–‹å§‹æº–å‚™æ¸¬è©¦ç’°å¢ƒ...'
                // åªåœ¨æœ‰å·¥ä½œç©ºé–“æ™‚æ¸…ç†
                script {
                    try {
                        cleanWs()
                    } catch (Exception e) {
                        echo "å·¥ä½œç©ºé–“æ¸…ç†è·³é: ${e.getMessage()}"
                    }
                }
                
                bat '''
                    if not exist src\\test\\java mkdir src\\test\\java
                    if not exist src\\main\\resources mkdir src\\main\\resources
                '''
            }
        }
        
        stage('æª¢æŸ¥ç’°å¢ƒ') {
            steps {
                echo 'æª¢æŸ¥ç’°å¢ƒä¾è³´...'
                script {
                    // æª¢æŸ¥ Java ç‰ˆæœ¬
                    try {
                        bat 'java -version'
                    } catch (Exception e) {
                        error "Java æœªå®‰è£æˆ–ç„¡æ³•åŸ·è¡Œ: ${e.getMessage()}"
                    }
                    
                    // æª¢æŸ¥ Maven ç‰ˆæœ¬
                    try {
                        bat 'mvn --version'
                        echo 'âœ… Maven ç’°å¢ƒæª¢æŸ¥é€šé'
                    } catch (Exception e) {
                        error "Maven ç„¡æ³•åŸ·è¡Œï¼Œè«‹æª¢æŸ¥è·¯å¾‘: ${e.getMessage()}"
                    }
                    
                    // é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
                    echo "MAVEN_HOME: ${env.MAVEN_HOME}"
                    echo "PATH: ${env.PATH}"
                }
            }
        }
        
        stage('å®‰è£ä¾è³´') {
            steps {
                echo 'å®‰è£æ¸¬è©¦ä¾è³´...'
                
                // å‰µå»º pom.xml - ä½¿ç”¨ HTTP å®¢æˆ¶ç«¯è€Œé Selenium
                writeFile file: 'pom.xml', text: '''<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.test</groupId>
    <artifactId>web-connectivity-test</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
    <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
        <junit.version>5.9.2</junit.version>
        <okhttp.version>4.12.0</okhttp.version>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
            <version>${okhttp.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jsoup</groupId>
            <artifactId>jsoup</artifactId>
            <version>1.16.1</version>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.0.0-M9</version>
            </plugin>
        </plugins>
    </build>
</project>'''
                
                sh 'mvn clean compile test-compile'
            }
        }
        
        stage('å‰µå»ºæ¸¬è©¦ç¨‹å¼') {
            steps {
                echo 'å‰µå»ºç¶²ç«™é€£é€šæ€§æ¸¬è©¦ç¨‹å¼...'
                
                // å‰µå»ºæ¸¬è©¦é¡åˆ¥ - æ¸¬è©¦å¤šå€‹ç¶²ç«™çš„é€£é€šæ€§
                writeFile file: 'src/test/java/WebConnectivityTest.java', text: '''
import okhttp3.*;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import static org.junit.jupiter.api.Assertions.*;

import java.io.IOException;
import java.time.Duration;
import java.util.concurrent.TimeUnit;

public class WebConnectivityTest {
    
    private OkHttpClient client;
    
    @BeforeEach
    public void setUp() {
        // è¨­å®š HTTP å®¢æˆ¶ç«¯ï¼Œæ¨¡æ“¬çœŸå¯¦ç€è¦½å™¨
        client = new OkHttpClient.Builder()
            .connectTimeout(10, TimeUnit.SECONDS)
            .readTimeout(30, TimeUnit.SECONDS)
            .addInterceptor(chain -> {
                Request original = chain.request();
                Request.Builder requestBuilder = original.newBuilder()
                    .header("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
                    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
                    .header("Accept-Language", "zh-TW,zh;q=0.9,en;q=0.8")
                    .header("Accept-Encoding", "gzip, deflate")
                    .header("Connection", "keep-alive");
                
                Request request = requestBuilder.build();
                return chain.proceed(request);
            })
            .build();
    }
    
    @Test
    @DisplayName("æ¸¬è©¦ Google ç¶²ç«™é€£é€šæ€§")
    public void testGoogleConnectivity() throws IOException {
        System.out.println("é–‹å§‹æ¸¬è©¦ Google é€£é€šæ€§...");
        
        Request request = new Request.Builder()
            .url("https://www.google.com")
            .build();
        
        try (Response response = client.newCall(request).execute()) {
            // é©—è­‰ HTTP ç‹€æ…‹ç¢¼
            int statusCode = response.code();
            System.out.println("Google å›æ‡‰ç‹€æ…‹ç¢¼: " + statusCode);
            assertTrue(statusCode >= 200 && statusCode < 400, 
                "Google æ‡‰è©²å›æ‡‰æˆåŠŸç‹€æ…‹ç¢¼ï¼Œå¯¦éš›æ”¶åˆ°: " + statusCode);
            
            // é©—è­‰å…§å®¹
            String responseBody = response.body().string();
            assertNotNull(responseBody, "å›æ‡‰å…§å®¹ä¸æ‡‰ç‚ºç©º");
            assertTrue(responseBody.length() > 0, "å›æ‡‰å…§å®¹é•·åº¦æ‡‰å¤§æ–¼0");
            
            // ä½¿ç”¨ Jsoup è§£æ HTML
            Document doc = Jsoup.parse(responseBody);
            String title = doc.title();
            System.out.println("é é¢æ¨™é¡Œ: " + title);
            assertTrue(title.toLowerCase().contains("google"), 
                "é é¢æ¨™é¡Œæ‡‰åŒ…å« 'google'");
            
            System.out.println("âœ… Google é€£é€šæ€§æ¸¬è©¦é€šé");
        }
    }
    
    @Test
    @DisplayName("æ¸¬è©¦ GitHub ç¶²ç«™é€£é€šæ€§")
    public void testGitHubConnectivity() throws IOException {
        System.out.println("é–‹å§‹æ¸¬è©¦ GitHub é€£é€šæ€§...");
        
        Request request = new Request.Builder()
            .url("https://github.com")
            .build();
        
        try (Response response = client.newCall(request).execute()) {
            int statusCode = response.code();
            System.out.println("GitHub å›æ‡‰ç‹€æ…‹ç¢¼: " + statusCode);
            assertTrue(statusCode >= 200 && statusCode < 400, 
                "GitHub æ‡‰è©²å›æ‡‰æˆåŠŸç‹€æ…‹ç¢¼ï¼Œå¯¦éš›æ”¶åˆ°: " + statusCode);
            
            String responseBody = response.body().string();
            Document doc = Jsoup.parse(responseBody);
            String title = doc.title();
            System.out.println("GitHub é é¢æ¨™é¡Œ: " + title);
            
            System.out.println("âœ… GitHub é€£é€šæ€§æ¸¬è©¦é€šé");
        }
    }
    
    @Test
    @DisplayName("æ¸¬è©¦ Stack Overflow ç¶²ç«™é€£é€šæ€§")
    public void testStackOverflowConnectivity() throws IOException {
        System.out.println("é–‹å§‹æ¸¬è©¦ Stack Overflow é€£é€šæ€§...");
        
        Request request = new Request.Builder()
            .url("https://stackoverflow.com")
            .build();
        
        try (Response response = client.newCall(request).execute()) {
            int statusCode = response.code();
            System.out.println("Stack Overflow å›æ‡‰ç‹€æ…‹ç¢¼: " + statusCode);
            assertTrue(statusCode >= 200 && statusCode < 400, 
                "Stack Overflow æ‡‰è©²å›æ‡‰æˆåŠŸç‹€æ…‹ç¢¼ï¼Œå¯¦éš›æ”¶åˆ°: " + statusCode);
            
            String responseBody = response.body().string();
            Document doc = Jsoup.parse(responseBody);
            String title = doc.title();
            System.out.println("Stack Overflow é é¢æ¨™é¡Œ: " + title);
            
            System.out.println("âœ… Stack Overflow é€£é€šæ€§æ¸¬è©¦é€šé");
        }
    }
    
    @Test
    @DisplayName("æ¸¬è©¦ç¶²ç«™å›æ‡‰æ™‚é–“")
    public void testWebsiteResponseTime() throws IOException {
        System.out.println("é–‹å§‹æ¸¬è©¦ç¶²ç«™å›æ‡‰æ™‚é–“...");
        
        String[] urls = {
            "https://www.google.com",
            "https://github.com",
            "https://stackoverflow.com"
        };
        
        for (String url : urls) {
            long startTime = System.currentTimeMillis();
            
            Request request = new Request.Builder()
                .url(url)
                .build();
            
            try (Response response = client.newCall(request).execute()) {
                long endTime = System.currentTimeMillis();
                long responseTime = endTime - startTime;
                
                System.out.println(url + " å›æ‡‰æ™‚é–“: " + responseTime + "ms");
                
                // é©—è­‰å›æ‡‰æ™‚é–“ä¸è¶…é 10 ç§’
                assertTrue(responseTime < 10000, 
                    url + " å›æ‡‰æ™‚é–“éé•·: " + responseTime + "ms");
            }
        }
        
        System.out.println("âœ… å›æ‡‰æ™‚é–“æ¸¬è©¦é€šé");
    }
    
    @Test
    @DisplayName("æ¸¬è©¦ç„¡æ•ˆç¶²å€è™•ç†")
    public void testInvalidUrlHandling() {
        System.out.println("é–‹å§‹æ¸¬è©¦ç„¡æ•ˆç¶²å€è™•ç†...");
        
        Request request = new Request.Builder()
            .url("https://this-website-does-not-exist-12345.com")
            .build();
        
        assertThrows(IOException.class, () -> {
            try (Response response = client.newCall(request).execute()) {
                // é€™è£¡æ‡‰è©²æ‹‹å‡ºç•°å¸¸
            }
        }, "ç„¡æ•ˆç¶²å€æ‡‰è©²æ‹‹å‡º IOException");
        
        System.out.println("âœ… ç„¡æ•ˆç¶²å€è™•ç†æ¸¬è©¦é€šé");
    }
}'''
            }
        }
        
        stage('åŸ·è¡Œæ¸¬è©¦') {
            steps {
                echo 'åŸ·è¡Œç¶²ç«™é€£é€šæ€§æ¸¬è©¦...'
                
                script {
                    try {
                        // åŸ·è¡Œæ¸¬è©¦
                        bat "mvn test"
                        echo 'æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼'
                        
                    } catch (Exception e) {
                        echo "æ¸¬è©¦åŸ·è¡Œå¤±æ•—: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }
        
        stage('ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š') {
            steps {
                echo 'ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š...'
                
                // ç™¼å¸ƒæ¸¬è©¦çµæœ
                publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                
                // ä¿å­˜æ¸¬è©¦å ±å‘Š
                archiveArtifacts artifacts: 'target/surefire-reports/**/*', 
                                allowEmptyArchive: true
                
                // é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦
                script {
                    def testResults = currentBuild.rawBuild.getAction(hudson.tasks.test.AbstractTestResultAction.class)
                    if (testResults) {
                        echo "æ¸¬è©¦çµæœæ‘˜è¦:"
                        echo "ç¸½æ¸¬è©¦æ•¸: ${testResults.totalCount}"
                        echo "é€šéæ¸¬è©¦: ${testResults.totalCount - testResults.failCount}"
                        echo "å¤±æ•—æ¸¬è©¦: ${testResults.failCount}"
                        echo "è·³éæ¸¬è©¦: ${testResults.skipCount}"
                    }
                }
            }
        }
        
        stage('ç¶²è·¯è¨ºæ–·') {
            steps {
                echo 'åŸ·è¡Œç¶²è·¯é€£é€šæ€§è¨ºæ–·...'
                
                script {
                    // Windows ç¶²è·¯è¨ºæ–·å‘½ä»¤
                    bat '''
                        echo === ç¶²è·¯è¨ºæ–·è³‡è¨Š ===
                        echo æ¸¬è©¦ DNS è§£æ:
                        nslookup google.com || echo DNS è§£æå¤±æ•—
                        
                        echo æ¸¬è©¦ç¶²è·¯é€£é€šæ€§:
                        ping -n 3 8.8.8.8 || echo ç¶²è·¯é€£é€šæ€§æ¸¬è©¦å¤±æ•—
                        
                        echo æ¸¬è©¦ HTTPS é€£æ¥:
                        curl -I https://www.google.com --connect-timeout 10 || echo HTTPS é€£æ¥å¤±æ•—ï¼Œå¯èƒ½éœ€è¦å®‰è£ curl
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'æ¸…ç†æ¸¬è©¦ç’°å¢ƒ...'
                script {
                    try {
                        // ä½¿ç”¨ Windows å‘½ä»¤æ¸…ç†è€Œä¸æ˜¯ cleanWs()
                        bat '''
                            if exist target rmdir /s /q target
                            if exist src rmdir /s /q src
                            if exist pom.xml del pom.xml
                        '''
                    } catch (Exception e) {
                        echo "æ¸…ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${e.getMessage()}"
                    }
                }
            }
        }
        
        success {
            echo 'âœ… ç¶²ç«™é€£é€šæ€§æ¸¬è©¦å…¨éƒ¨é€šéï¼'
            
            script {
                // è¨ˆç®—æ¸¬è©¦çµ±è¨ˆ
                def testResults = currentBuild.rawBuild.getAction(hudson.tasks.test.AbstractTestResultAction.class)
                if (testResults) {
                    def message = """
                    ğŸ‰ ç¶²ç«™é€£é€šæ€§æ¸¬è©¦æˆåŠŸå®Œæˆï¼
                    ğŸ“Š æ¸¬è©¦çµ±è¨ˆ:
                    â€¢ ç¸½æ¸¬è©¦æ•¸: ${testResults.totalCount}
                    â€¢ é€šé: ${testResults.totalCount - testResults.failCount}
                    â€¢ å¤±æ•—: ${testResults.failCount}
                    â€¢ è·³é: ${testResults.skipCount}
                    ğŸ”— Build: #${env.BUILD_NUMBER}
                    """.stripIndent()
                    
                    echo message
                    
                    // å¯é¸ï¼šç™¼é€é€šçŸ¥åˆ° Slack
                    if (env.SLACK_WEBHOOK) {
                        slackSend(
                            channel: '#testing',
                            color: 'good',
                            message: message
                        )
                    }
                }
            }
        }
        
        failure {
            echo 'âŒ ç¶²ç«™é€£é€šæ€§æ¸¬è©¦å¤±æ•—ï¼'
            
            script {
                if (env.SLACK_WEBHOOK) {
                    slackSend(
                        channel: '#testing',
                        color: 'danger',
                        message: "âŒ ç¶²ç«™é€£é€šæ€§æ¸¬è©¦å¤±æ•— - Build #${env.BUILD_NUMBER}\\nè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç›®æ¨™ç¶²ç«™ç‹€æ…‹"
                    )
                }
            }
        }
        
        unstable {
            echo 'âš ï¸  æ¸¬è©¦çµæœä¸ç©©å®šï¼Œéƒ¨åˆ†æ¸¬è©¦å¤±æ•—'
        }
    }
}